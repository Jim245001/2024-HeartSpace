@model HeartSpace.Models.ViewModels.EventViewModel

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@Model.EventName 報名人員清單</title>
    <style>

        .outerbox {
            width: 80%;
            border-radius: 10px;
            background-color: #f9f9f9;
            margin: 0 auto;
            padding: 30px;
            //border: 1px solid #ccc;
        }
        #dropdownMenuButton {
            color: #555; /* 修改按鈕顏色 */
            font-size: 1.3rem;
        }

        .dropdown-toggle-custom i:hover {
            color: #fcb874; /* 懸停時顏色 */

    </style>
</head>
<body> 
    
    <div class="outerbox">
        <!-- 照片 -->
        <div class="text-center mb-4">
            @if (!string.IsNullOrEmpty(Model.Img))
            {
                <img src="@Url.Content(Model.Img)"
                     style="aspect-ratio: 3 / 1; border-radius: 10px; object-fit: cover; display: block; margin: 0 auto;" />
            }
            else
            {
                <div class="d-flex justify-content-center align-items-center"
                     style="background-color: #f2f2f2; aspect-ratio: 3 / 1; border-radius: 10px; display: block; margin: 0 auto;">
                    <i class="fa-regular fa-image"
                       style="font-size: 80px; color: #aaa;"></i>
                </div>
            }
        </div>



        <!-- 標題與發起人資訊 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <!-- 標題 -->
            <div>
                <h1 style="margin: 0; font-size: 2rem; font-weight: bold; color: #333;">@Model.EventName</h1>
            </div>
            <!-- 發起人資訊 -->
            <div class="d-flex flex-column align-items-center">
                <div class="mb-1">
                    @if (!string.IsNullOrEmpty(Model.MemberImg))
                    {
                        // 顯示圖片，使用路徑
                        <img src="@Url.Content(Model.MemberImg)"
                             style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #ccc;" />
                    }
                    else
                    {
                        // 顯示預設的 Font Awesome 圖標
                        <i class="fa-regular fa-circle-user" style="font-size: 50px; color: #ccc;"></i>
                    }
                </div>
                <div>
                    <p class="mb-0" style="font-size: 1.1rem; font-weight: bold; color: #555;">@Model.MemberNickName</p>
                </div>
            </div>
        </div>


        <!-- 類別、線上線下、時間 -->
        <div class="d-flex justify-content-start align-items-center text-muted mb-4" style="font-size: 1.1rem;">
            <div class="d-flex align-items-center me-4">
                <i class="bi bi-tag" style="font-size: 1.5rem; margin-right: 5px;" title="類別"></i>
                <span>@Model.CategoryName</span>
            </div>
            <div class="d-flex align-items-center me-4">
                <i class="bi bi-calendar" style="font-size: 1.5rem; margin-right: 5px;" title="時間"></i>
                <span>@Model.EventTime.ToString("yyyy-MM-dd HH:mm")</span>
            </div>
            <div class="d-flex align-items-center me-4">
                <i class="bi @(Model.IsOnline ? "bi-globe" : "bi-geo-alt")"
                   style="font-size: 1.5rem; margin-right: 5px;" title="線上/線下"></i>
                <span>@(Model.IsOnline ? "線上" : "線下") | @Model.Location</span>
            </div>
            <div class="d-flex align-items-center">
                <i class="bi bi-people-fill" style="font-size: 1.5rem; margin-right: 5px;" title="人數限制"></i>
                <span>@Model.ParticipantMin ~ @Model.ParticipantMax</span>
            </div>
        </div>

        <!-- 聚會描述 -->
        <div class="bg-light p-4 rounded mb-4 shadow-sm" style="font-size: 1.1rem; color: #444; 
                    background-color: #d1e1ec; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); ">
            <p class="mb-0">@Model.Description</p>
        </div>

        <!-- 報名截止日期與報名人數 -->
        <div class="d-flex justify-content-between mb-4" style="font-size: 1.1rem; color: #555;">
            <p><strong>報名截止日：</strong>@Model.DeadLine.ToString("yyyy-MM-dd HH:mm")</p>
            <p><strong>目前報名人數：</strong>@Model.ParticipantNow</p>
        </div>

        <!-- 下方功能按鈕 -->
        <div class="">
            <!-- 報名按鈕 -->
            <div class="text-center mb-4" style="width: 100%; margin: 0 auto; ">
                @if (Model.IsEventOwner || Model.Role == "admin")
                {
                    <!-- 查看報名狀況按鈕 -->
                    <a href="@Url.Action("EventStatus", "Event", new { id = Model.Id })"
                       class="btn w-100 py-2"
                       style="font-size: 1.2rem; color: black; background-color: #FDD9A0; border: none; border-radius: 8px;">
                        查看報名狀況
                    </a>
                }
                else if (Model.IsRegistered)
                {
                    <!-- 取消報名按鈕 -->
                    <button class="btn w-100 py-2"
                            style="font-size: 1.2rem; color: black; background-color: #FDD9A0; border: none; border-radius: 8px;"
                            data-bs-toggle="modal" data-bs-target="#confirmCancelModal">
                        取消報名
                    </button>
                }
                else if (Model.IsFull)
                {
                    <!-- 報名已滿 -->
                    <button class="btn w-100 py-2"
                            style="font-size: 1.2rem; color: gray; background-color: #e6e6e6; border: none; border-radius: 8px;"
                            disabled>
                        報名人數已滿
                    </button>
                }
                else
                {
                    <!-- 報名活動按鈕 -->
                    <button class="btn w-100 py-2"
                            style="font-size: 1.2rem; color: black; background-color: #FDD9A0; border: none; border-radius: 8px;"
                            data-bs-toggle="modal" data-bs-target="#confirmRegisterModal">
                        報名活動
                    </button>
                }
            </div>

            <!-- 取消報名確認視窗 -->
            <div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="confirmCancelModalLabel">確認取消報名</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            您確定要取消報名此活動嗎？
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <form action="@Url.Action("ToggleRegistration", "Event")" method="post">
                                <input type="hidden" name="eventId" value="@Model.Id" />
                                <input type="hidden" name="actionType" value="cancel" />
                                <button type="submit" class="btn btn-danger">確定取消</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 報名活動確認視窗 -->
            <div class="modal fade" id="confirmRegisterModal" tabindex="-1" aria-labelledby="confirmRegisterModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="confirmRegisterModalLabel">確認報名活動</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            您確定要報名此活動嗎？
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <form action="@Url.Action("ToggleRegistration", "Event")" method="post">
                                <input type="hidden" name="eventId" value="@Model.Id" />
                                <input type="hidden" name="actionType" value="register" />
                                <button type="submit" class="btn btn-success">確定報名</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 關閉、修改 -->
            <div class="text-center mb-2" style="width: 90%; margin: 0 auto; ">
                @if (Model.IsEventOwner || Model.Role == "admin")
                {
                    <div class="d-flex justify-content-between" style="gap: 10px; margin: 0 auto;">
                        @if (Model.IsEventOwner || Model.Role == "admin")
                        {
                            <!-- 關閉按鈕 -->
                            <button class="btn btn-warning w-100 py-2"
                                    style="font-size: 1.2rem; background-color: #adbec9; border: none; border-radius: 8px;"
                                    data-bs-toggle="modal" data-bs-target="#confirmCloseModal">
                                關閉揪團
                            </button>
                        }

                        @if (Model.IsEventOwner)
                        {
                            <!-- 修改按鈕 -->
                            <a href="@Url.Action("EditEvent", "Event", new { id = Model.Id })"
                               class="btn btn-warning w-100 py-2"
                               style="font-size: 1.2rem; background-color: #adbec9; border: none; border-radius: 8px;">
                                修改揪團
                            </a>
                        }
                    </div>
                }
            </div>


            <!-- 關閉活動確認彈窗 -->
            <div class="modal fade" id="confirmCloseModal" tabindex="-1" aria-labelledby="confirmCloseModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="confirmCloseModalLabel">確認關閉活動</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            您確定要關閉這個活動嗎？關閉後將無法恢復。
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <form action="@Url.Action("CloseEvent", "Event")" method="post">
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn btn-danger">確認關閉</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr style="border: 1px solid #ccc; margin: 30px 0;" />
        <!-- 留言 -->
        <div class=" mt-3">
            <div class="section-title" style="font-size: 1.5rem; font-weight: bold; margin: 20px 0; color: #555; ">
                <i class="fa-solid fa-comments" style="font-size: 2rem; color: #6a7888; "></i>
                  留言板
            </div>
            <!-- 留言輸入區 -->
            <div class="mb-3">
                @using (Html.BeginForm("AddComment", "Event", FormMethod.Post, new { @class = "d-flex flex-column" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="eventId" value="@Model.Id" />

                    <!-- 留言框 -->
                    <textarea id="commentContent" name="commentContent" class="form-control mb-2" rows="3" placeholder="留下你的意見" style="resize: none;"></textarea>

                    <!-- 按鈕區 -->
                    <div class="d-flex justify-content-end align-items-center">
                        <!-- 取消按鈕 -->
                        <button type="button" class="btn btn-secondary me-2" id="cancelComment">
                            取消
                        </button>
                        <!-- 留言按鈕 -->
                        <button type="submit" id="submitComment" class="btn btn-warning" style="background-color: #FDD9A0; border: none;" disabled>
                            留言
                        </button>
                    </div>
                }
            </div>

            <!-- 留言顯示區 -->
            <input type="hidden" id="eventId" value="@Model.Id" />
            <div class="comments">
                @foreach (var comment in Model.Comments)
                {
                    <div class="d-flex align-items-start mb-3">
                        <!-- 留言者大頭照 -->
                        @if (!string.IsNullOrEmpty(comment.MemberImg))
                        {
                            <img src="@comment.MemberImg"
                                 class="rounded-circle me-3" alt="Avatar"
                                 style="width: 50px; height: 50px; object-fit: cover;" />
                        }
                        else
                        {
                            <i class="fa-regular fa-circle-user me-3"
                               style="font-size: 50px; color: #ccc;"></i>
                        }

                        <div class="flex-grow-1">
                            <!-- 留言者姓名 -->
                            <p class="mb-1"><strong>@comment.MemberNickName</strong></p>
                            <!-- 留言內容 -->
                            <p class="mb-1">@comment.EventCommentContent</p>
                            <!-- 留言時間 -->
                            <small class="text-muted">@comment.CommentTime.ToString("MM/dd HH:mm")</small>
                        </div>

                        <!-- 如果是留言者本人，顯示編輯與刪除選單 -->
                        @if (comment.IsCommentOwner)
                        {
                            <div class="dropdown">
                                <button class="btn dropdown-toggle-custom" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>

                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                    <li>
                                        <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editCommentModal"
                                                onclick="loadCommentData(@comment.Id, '@comment.EventCommentContent')">
                                            編輯留言
                                        </button>
                                    </li>
                                    <li>
                                        <form id="deleteForm" action="@Url.Action("DeleteComment", "Event")" method="post">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="commentId" id="deleteCommentId" />
                                            <input type="hidden" name="eventId" value="@Model.Id" />
                                            <button type="button" class="dropdown-item text-danger" onclick="openDeleteModal(@comment.Id)">刪除留言</button>
                                        </form>

                                    </li>

                                </ul>
                            </div>



                        }
                    </div>
                }
            </div>

            <!-- 編輯留言模態框 -->
            <div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <!-- 表單開始 -->
                        <form action="@Url.Action("EditComment", "Event")" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" id="editCommentId" name="commentId" />
                            <input type="hidden" id="eventId" name="eventId" value="@Model.Id" />
                            <div class="modal-header">
                                <h5 class="modal-title fw-bold" id="editCommentModalLabel">編輯我的留言</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <textarea class="form-control" id="editCommentContent" name="updatedContent" rows="4" required></textarea>
                            </div>
                            <div class="modal-footer justify-content-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary" style="background-color: #FDD9A0; border: none; color: black">儲存</button>
                            </div>
                        </form>
                        <!-- 表單結束 -->
                    </div>
                </div>
            </div>

            <!-- 刪除確認模態框 -->
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold" id="deleteModalLabel">HeartSpace心聚點</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            是否確認刪除此留言？
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteButton">刪除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

        @section Scripts {
            <script>
                //刪除留言
                function openDeleteModal(commentId) {
                    // 設置模態框中的隱藏字段值
                    document.getElementById('deleteCommentId').value = commentId;

                    // 顯示刪除確認模態框
                    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    deleteModal.show();

                    // 綁定刪除按鈕的行為
                    document.getElementById('confirmDeleteButton').onclick = function () {
                        document.getElementById('deleteForm').submit();
                    };
                }
                //編輯留言
                function openEditModal(commentId, commentContent) {
                    document.getElementById('editCommentId').value = commentId;
                    document.getElementById('editCommentContent').value = commentContent;
                    new bootstrap.Modal(document.getElementById('editCommentModal')).show();
                }

                function confirmDelete() {
                    return confirm("是否確認刪除此留言？");
                }

                function loadCommentData(commentId, content) {
                    // 將留言的 ID 和內容填充到模態框中
                    document.getElementById('editCommentId').value = commentId;
                    document.getElementById('editCommentContent').value = content;
                }

                document.addEventListener("DOMContentLoaded", function () {
                    const commentBox = document.getElementById("commentContent");
                    const submitButton = document.getElementById("submitComment");
                    const cancelButton = document.getElementById("cancelComment");

                    if (commentBox && submitButton) {
                        // 當留言框有內容時啟用留言按鈕
                        commentBox.addEventListener("input", function () {
                            if (this.value.trim().length > 0) {
                                submitButton.disabled = false;
                            } else {
                                submitButton.disabled = true;
                            }
                        });

                        // 取消按鈕清空內容並禁用留言按鈕
                        cancelButton.addEventListener("click", function () {
                            commentBox.value = ""; // 清空留言框
                            submitButton.disabled = true; // 禁用留言按鈕
                        });
                    }
                });
            </script>
        }
